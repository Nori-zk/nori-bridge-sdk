name: Build nori-bridge-sdk

on:
  pull_request:
    types: [closed]
    branches:
      - build

jobs:
  build-nori-bridge-sdk:
    name: Build nori-bridge-sdk is a REN release, based on a pull request close (merge=true) event, with the branch 'build' as the PR target.
    if: github.event.pull_request.merged == true
    runs-on: [self-hosted, nori, highperf]
    permissions:
      contents: read
      pull-requests: write
    container:
      image: docker.nori.it.com/stacksmith:1.0.0
      volumes:
        # SSH for git operations
        - /home/runner/.ssh:/root/.ssh:ro
        
        # NPM registry auth
        - /home/runner/.npmrc:/github/home/.npmrc:ro

        # Stacksmith envs (used to enable specific pipelines which need env vars)
        - /home/runner/.stacksmith.envs:/root/.stacksmith.envs:ro

        # This makes the path consistent across parent and sibling containers
        - /tmp/stacksmith_repos:/tmp/stacksmith_repos

    timeout-minutes: 180

    # Define lightnet service
    services:
      mina-lightnet:
        image: o1labs/mina-local-network:compatible-latest-devnet
        env:
          PROOF_LEVEL: full
          LOG_LEVEL: Debug
          RUN_ARCHIVE_NODE: true
          SLOT_TIME: 20000
          NETWORK_TYPE: single-node
          PATH: /root/.nvm/versions/node/v22.9.0/bin/:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/postgresql/14/bin
          GOSU_VERSION: 1.17
          LANG: en_US.utf8
          PG_MAJOR: 14
          PG_VERSION: 14.17-1.pgdg120+1
          PGDATA: /var/lib/postgresql/data
          NODE_VERSION: 22.9.0
          NVM_DIR: /root/.nvm
          MINA_LIBP2P_HELPER_PATH: /root/libp2p_helper
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: archive

    steps:
      - name: Comment on PR - Build Started
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const commitUrl = `${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.pull_request.merge_commit_sha }}`;
            const repoName = context.repo.repo;
            const message = `üî® **Build started** for ${repoName}\n\n**Commit:** [\`${{ github.event.pull_request.merge_commit_sha }}\`](${commitUrl})\n**Workflow:** [View run details](${runUrl})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Cleanup job home cache
        run: |
          echo "Cleaning job home directory cache..."
          if [ -d "/__w/_temp/_github_home/.cache" ]; then
            rm -rf /__w/_temp/_github_home/.cache
            echo "Home cache cleaned"
          else
            echo "No cache found to clean"
          fi

      - name: Wait for lightnet to be ready
        shell: bash
        run: |
          apt-get update && apt install -y curl jq
          echo "‚è≥ Waiting for Mina lightnet to be ready..."
          for i in {1..60}; do
            if curl -sf http://mina-lightnet:8181/ > /dev/null; then
              echo "‚úÖ Mina is ready!"
              exit 0
            fi
            echo "Attempt $i/60 failed, waiting 10s..."
            sleep 10
          done
          echo "‚ùå Mina failed to become ready after 60 attempts (10 minutes)"
          exit 1

      - name: Run the nori-bridge-sdk workflow, run integration tests and build images.
        shell: bash
        run: |
          mkdir -p /tmp/stacksmith_repos
          stacksmith run bridge-sdk \
            --pr-number ${{ github.event.pull_request.number }} \
            --build-id "nori-bridge-sdk-${{ github.event.pull_request.number }}-${{ github.run_id }}-${{ github.run_number }}" \
            --target-branch build \
            --envs-dir /root/.stacksmith.envs \
            --working-dir /tmp/stacksmith_repos

      - name: Comment on PR - Build Complete
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const commitUrl = `${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.pull_request.merge_commit_sha }}`;
            const repoName = context.repo.repo;
            let message;
            
            if ('${{ job.status }}' === 'success') {
              message = `‚úÖ **Build succeeded** for ${repoName}\n\n**Commit:** [\`${{ github.event.pull_request.merge_commit_sha }}\`](${commitUrl})\n**Workflow:** [View run details](${runUrl})`;
            } else {
              message = `‚ùå **Build failed** for ${repoName}\n\n**Commit:** [\`${{ github.event.pull_request.merge_commit_sha }}\`](${commitUrl})\n**Workflow:** Check the [workflow run](${runUrl}) for details.\n\n‚ö†Ô∏è Review the logs to identify the failure cause.`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Cleanup stacksmith working dir
        if: always()
        run: |
          stacksmith cleanup --working-dir /tmp/stacksmith_repos
          echo "Cleanup completed"

      - name: Cleanup job home cache
        if: always()
        run: |
          echo "Cleaning job home directory cache..."
          if [ -d "/__w/_temp/_github_home/.cache" ]; then
            rm -rf /__w/_temp/_github_home/.cache
            echo "Home cache cleaned"
          else
            echo "No cache found to clean"
          fi
