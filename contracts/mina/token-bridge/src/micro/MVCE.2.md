# Preamble

Problems with o1js not always compiling ZK programs such that they yield a verification key hash with the same value in all compliation situations. Particularly concerning one ZK program namely EthVerifier (located here `<nori-bridge-sdk root directory>/o1js-zk-utils/src/ethVerifier.ts`)

# Description

We have had constant problems with the reliability of building zk programs with consistent vks for some of our programs and we have a historically relied on a defensive solution for to assist us in mitigating such behaviour, developed in March 2025. We 'bake' verification key hash strings into the repository itself for EthVerifier they can be seen here `<nori-bridge-sdk root directory>/o1js-zk-utils/src/integrity/EthVerifier.VkHash.json` which is generated when running `cd <nori-bridge-sdk root directory>/o1js-zk-utils && npm run bake-vk-hashes` which creates an cache emphemeral directory and compiles EthVerifier in this fresh directory and then stores the VK's hash into the json file. Later when running programs which rely on this zk program, we compile using the default o1js cache dir and then compare the compiled vk hash against the stored hash, if the vk hash does not match we throw an exception (and we advice the user to clear their o1js cache), this panic prevents other spurious error down the line which can have confusing descriptions. Thus the aim is to  validate our compile zk program and ensure that the zk program is reliably reproduced from the default cache directory when running in node.js (typically found at `~/.cache/o1js` on ubuntu) or from within browser (which effectively always has a cold cache for zk programs [not nessesarily for contracts which may have a bespoke cache strategy]).

When running `cd <nori-bridge-sdk root directory>/o1js-zk-utils && npm run bake-vk-hashes` or one of the a test e.g. one located in `cd <nori-bridge-sdk-root-dir>/contracts/mina/token-bridge` running `rm ~/.cache/o1js/* && npm run test -- src/micro/e2e.litenet.without-infra.spec.ts` or `rm ~/.cache/o1js/* && npm run test -- src/micro/e2e.devnet.without-infra.spec.ts`, we obtain the following vk hash for EthVerifier `18898419980749081858185627310467310990096965437609867313373155526674043887824` (referred to as 'ending in 24').

Moreover it is important to note we have another smart contract which depends on EthVerifier namely EthProcessor (located in `<nori-bridge-sdk root directory>/contracts/mina/eth-processor`). If you ensure you have a clean cache `rm ~/.cache/o1js/*`, you can verify `18898419980749081858185627310467310990096965437609867313373155526674043887824` is the derived verification key hash by running one of these tests e.g. `rm ~/.cache/o1js/* && cd <nori-bridge-sdk root directory>/contracts/mina/eth-processor && npm run test-ci`, 'test-ci' runs each test one after another each within it unique node.js runtime. Alternatively if one runs 'test' as opposed to 'test-ci' it will run the same tests within one node.js runtime and one will experience hanging behaviour where consecutive invocations (more than 2 cycles) to o1js async prove/submit methods (contained within the proofSubmitter) never resolve / reject. This behaviour prompted us to create an child subprocess abstraction in a private repository to only ever run one method before terminating the worker and rebuilding another ready for the next needed command. This mitigation has worked for us and we finally achieved some reliability with this strategy.

The EthProcessorRabbit private repository has an equivalent of proofSubmitter class, but has one which compiles EthVerifier using a single child subprocess worker, it verifies the vk hash matches the stored hash (stored in the integrity folder `<nori-bridge-sdk root directory>/o1js-zk-utils/src/integrity`, and set/updated by running the `npm run bake-vk-hashes`) before it allows a fleet of workers to compile (in parallel) using the common cache, such that they too come up with the same vk hash, when they compile EthVerifier. This particular procedure was invented due to use having problems with the cache. Prior to us blocking the instantiation of the worker process pool while a single worker compiles and populates the common cache, we allowed all workers (child sub processes) to compile simulatiously using the common cache and in this case we could come up with a different vk ending in 65. We assumed this was due to some sort of read/write access contention and subsequent corruption of the cache. Then when we put in a mitigation strategy previously describe, this led us to a more consistent behaviour, this action was endorsed by o1js senior technical leadership at the time.

Recently we have while trying to get some of our e2e solutions working (see the e2e tests here `<nori-bridge-sdk-root-dir>/contracts/mina/token-bridge` and here `<nori-bridge-sdk-root-dir>/contracts/mina/token-bridge/slim` specifically) we have noticed that the devnet tests would ONLY complete (in node.js, the solution is inoperable in the browser) when (with a properly configure .env file to enable the devnet test to operate) we run the `e2e.prerequisites.spec.ts` test before hand i.e. `cd <nori-bridge-sdk root directory>/contracts/mina/token-bridge && rm ~/.cache/o1js/* && npm run test -- src/e2e.prerequisites.spec.ts && npm run test -- src/e2e.devnet.spec.ts` and the devnet tests would fail otherwise if running `cd <nori-bridge-sdk root directory>/contracts/mina/token-bridge && npm run test -- src/e2e.prerequisites.spec.ts`.

So what is the affect of running the pre-requisites test before? 

Without running the pre-requisites test before and with an empty cache EthVerifier will compile in the tests with the verification key hash ending '24'.

If we clear the cache, run the pre-requisites test, it will compile EthVerifier with a verification key hash ending in '65' (the same situation as what we were experiencing with the workers compiling EthVerifier in parallel). Then if the devnet test (either the slim or root build in mina-token-bridge) is subsequently run it will use the cache (aka the one which some compiled artifacts relating to EthVerifier made during the pre-requisites test) then when the devnet test compiles EthVerifier it too will compile and yield a verification key hash ending in '65'. These are the tests which do work on devnet in node.js.

Whats the difference between this situation and the parallel workers situation?

The pre-requisites test has no workers (no child sub processes)! All of the logic runs in a single main thread / node.js runtime. There is no parallel compilation of zk programs. This leads me to believe that the situation is not limited to the corruption of the same cache directory by some parallel read/write access of worker sub processes but is more fundamental. 

Moreover some difference between the workerfied EthProcessor solution scenario and the pre-requisites test is worth mentioning; our worker solution we only compute and verify EthVerfier first before compiling EthProcessor. With the pre-requisites test compiles some other ZK programs prior to compiling EthVerifier namely `EcdsaSigPresentationSpecPreCompile`, `EcdsaSigPresentationVerifier`, `EcdsaEthereum` (located in `<nori-bridge-sdk-root-dir>/contracts/mina/token-bridge/src/credentialAttestation.ts`) along with some helpers compiled within MinaAttestations (there is some HashHelper zk program).

This leads me to believe that the vk hash we obtain for ethVerifier when the cache is cold and when no other zk programs have been compiled prior to it, is actually different to one where some number of other zk programs have been compiled before it. That the vk hash derived from the compilation of our zk program is not always deterministic in all compilation scenarios.

# Steps to reproduce

0. `cd <nori-bridge-sdk root directory> && npm install && npm run build`
1. Run a program which compiles EthVerifier with an ephemeral cache directory (always clear)`cd <nori-bridge-sdk-root-dir>/o1js-zk-utils && npm run bake-vk-hashes`
2. Observe the printed EthVerifier Verification Key hash output `EthVerifier contract compiled vk: '18898419980749081858185627310467310990096965437609867313373155526674043887824'.`
3. Run the src/e2e.prerequisites.spec.ts test `cd <nori-bridge-sdk root directory>/contracts/mina/token-bridge && rm ~/.cache/o1js/* && npm run test -- src/e2e.prerequisites.spec.ts`
4. Observe the printed EthVerifier verification key has output `EthVerifier compiled vk: '15353094949572328638942911616600739835832014383382457564237536370555232424065'.`

# Other notes

Perhaps this relates to the issue described [here](./MVCE.1.a.md). But note that running `src/e2e.prerequisites.spec.ts` after clearing o1js cache directory, does not allow the devnet tests in the 'micro' build directory to succeed, whereas running `src/e2e.prerequisites.spec.ts` prior to running `src/e2e.devnet.spec.ts` and `src/slim/e2e.devnet.spec.ts` would allow them to succeed.